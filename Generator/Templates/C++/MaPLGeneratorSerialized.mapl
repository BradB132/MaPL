#import "../../Executable/MaPLGeneratorAPI.mapl"

string outputDir = commandLineFlag("cppOutputDir");
outputToFile(outputDir + "/MaPLGeneratorSerialized.hpp");

<?// Generated by MaPLGenerator.

#ifndef MaPLGeneratorSerialized_h
#define MaPLGeneratorSerialized_h

#include <vector>

enum MaPLGeneratorSerializedParseStatus {
    MaPLGeneratorSerializedParseStatus_success,
    MaPLGeneratorSerializedParseStatus_error,
    MaPLGeneratorSerializedParseStatus_completed,
};

/**
 * Abstract class that described how generated objects are serialized / deserialized.
 */
class MaPLGeneratorSerialized {
public:
    virtual bool initializeObjectWithData(uint8_t *data, size_t *dataIndex, size_t dataLength) = 0;
    virtual MaPLGeneratorSerializedParseStatus initializeAttributeWithData(uint8_t *data, size_t *dataIndex, size_t dataLength) = 0;
    virtual void writeObjectToVector(std::vector<uint8_t> &data) = 0;
    virtual void writeAttributesToVector(std::vector<uint8_t> &data) = 0;
};

?>

for uint32 schemaIndex = 0; schemaIndex < schemas.count; schemaIndex++ {
    Schema schema = schemas[schemaIndex];
    string schemaNamespace = schema.namespace;

    for uint32 classIndex = 0; classIndex < schema.classes.count; classIndex++ {
        SchemaClass schemaClass = schema.classes[classIndex];
        string classHashName = schemaClass.annotations.contains("originalName") ? schemaClass.annotations["originalName"] : schemaClass.name;
        uint32 beginClassHash = (uint32)hash("CLASS_BEGIN_" + schemaNamespace + "_" + classHashName);
        uint32 endClassHash = (uint32)hash("CLASS_END_" + schemaNamespace + "_" + classHashName);
<?#define BYTECODE_${schemaNamespace}_${schemaClass.name}_BEGIN ${beginClassHash}
#define BYTECODE_${schemaNamespace}_${schemaClass.name}_END ${endClassHash}
?>
        for uint32 attrIndex = 0; attrIndex < schemaClass.attributes.count; attrIndex++ {
            SchemaAttribute attribute = schemaClass.attributes[attrIndex];
            if attribute.annotations.contains("omit") {
                continue;
            }
            string attributeHashName = attribute.annotations.contains("originalName") ? attribute.annotations["originalName"] : attribute.name;
            uint32 attributeHash = (uint32)hash("ATTRIBUTE_" + schemaNamespace + "_" + classHashName + "_" + attributeHashName);
            <?#define BYTECODE_${schemaNamespace}_${schemaClass.name}_${attribute.name} ${attributeHash}
?>
        }
        <?
?>
    }
}

<?#endif /* MaPLGeneratorSerialized_h */
?>
